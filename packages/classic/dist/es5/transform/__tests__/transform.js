'use strict';var _immutable=require("immutable");var Subsystem=_interopRequireWildcard(require("../../subsystem"));var Kernel=_interopRequireWildcard(require("../../kernel"));var _=_interopRequireDefault(require(".."));function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj;}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key)){var desc=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):{};if(desc.get||desc.set){Object.defineProperty(newObj,key,desc);}else{newObj[key]=obj[key];}}}}newObj.default=obj;return newObj;}}var app=Subsystem.create(function(){return{name:'app'};});describe('Transform Subsytem',function(){var kernel=Kernel.create([_.default,app],{},{data:{defaultChildPositions:['content','children','left','right']}});var transformer=function transformer(){return kernel.subsystems.transform.buildTransformer();};var appState={kind:'app',url:'https://someurl.com',content:{kind:['scene'],metadata:{title:'Title',description:'Description'}}};var appStateMultiScene={kind:'app',url:'https://someurl.com',content:[{kind:['scene'],metadata:{title:'Title',description:'Description'}},{kind:['scene'],metadata:{title:'Title2',description:'Description2'}}]};var appStateMultiSceneWithSubElements={kind:'app',url:'https://someurl.com',content:[{kind:['scene'],metadata:{title:'Title',description:'Description'},content:{kind:'widget',title:'Widget Title'}},{kind:['scene'],metadata:{title:'Title2',description:'Description2'},content:[{kind:'widget',title:'Widget Title 1'},{kind:'widget',title:'Widget Title 2'}]}]};var appStateWithSubKinds={kind:'app',url:'https://someurl.com',children:[{kind:['scene','web'],metadata:{title:'Title',description:'Description'}},{kind:['scene','web'],metadata:{title:'Title2',description:'Description2'}}]};var appStateDualPanel={kind:'app',url:'https://someurl.com',left:{kind:'panel',metadata:{title:'Title left',description:'Description'}},right:[{kind:'panel',metadata:{title:'Title right 1',description:'Description'}},{kind:'panel',metadata:{title:'Title right 2',description:'Description'}}]};var appStateDualPanelSparse={kind:'app',url:'https://someurl.com',children:[{kind:'scene',left:{kind:'panel',metadata:{title:'Title left',description:'Description'}}},{kind:'scene',right:[{kind:'panel',metadata:{title:'Title right 1',description:'Description'}},{kind:'panel',metadata:{title:'Title right 2',description:'Description'}}]}]};afterEach(function(){_.default.transform.reset();app.transform.reset();});it('allows multiple transformers for the same kind, '+'Kernel.subsystemSequence determining the precedence',function(){app.transform.register(['scene'],function(element){return element.updateIn(['metadata','title'],function(t){return t+'!';});});_.default.transform.register(['scene'],function(element){return element.updateIn(['metadata','title'],function(t){return t+'*';});});app.transform.register(['scene'],function(element){return element.updateIn(['metadata','title'],function(t){return t+'#';});});var tt=transformer();var transformed=tt((0,_immutable.fromJS)(appState));expect(transformed.getIn(['content','metadata','title'])).toEqual('Title*!#');});it('should register and apply transformers with single scene',function(){app.transform.register(['scene'],function(element){return element.setIn(['metadata','title'],'Home page');});app.transform.register(['app'],function(element){return element.set('url','http://newurl.com');});var transformedAppState=transformer()((0,_immutable.fromJS)(appState));expect(transformedAppState.get('url')).toEqual('http://newurl.com');expect(transformedAppState.getIn(['content','metadata','title'])).toEqual('Home page');});it('should register and apply transformers with multiple scenes',function(){app.transform.register(['scene'],function(element){return element.setIn(['metadata','title'],'Home page');});app.transform.register(['app'],function(element){return element.set('url','http://newurl.com');});var transformedAppState=transformer()((0,_immutable.fromJS)(appStateMultiScene));expect(transformedAppState.get('url')).toEqual('http://newurl.com');expect(transformedAppState.getIn(['content',0,'metadata','title'])).toEqual('Home page');expect(transformedAppState.getIn(['content',1,'metadata','title'])).toEqual('Home page');});it('should register and apply multiple transfromers per kind',function(){app.transform.register(['scene'],function(element){return element.setIn(['metadata','title'],'Home page');});app.transform.register(['scene'],function(element){return element.setIn(['metadata','description'],'Home page description');});var transformedAppState=transformer()((0,_immutable.fromJS)(appState));expect(transformedAppState.getIn(['content','metadata','title'])).toEqual('Home page');expect(transformedAppState.getIn(['content','metadata','description'])).toEqual('Home page description');});it('should register and apply transformers for multiple scenes with widgets',function(){app.transform.register(['scene'],function(element){return element.setIn(['metadata','title'],'Home page');});app.transform.register(['app'],function(element){return element.set('url','http://newurl.com');});app.transform.register(['widget'],function(element){return element.set('title','New '+element.get('title'));});var transformedAppState=transformer()((0,_immutable.fromJS)(appStateMultiSceneWithSubElements));expect(transformedAppState.getIn(['content',0,'metadata','title'])).toEqual('Home page');expect(transformedAppState.getIn(['content',0,'content','title'])).toEqual('New Widget Title');expect(transformedAppState.getIn(['content',1,'content',0,'title'])).toEqual('New Widget Title 1');expect(transformedAppState.getIn(['content',1,'content',1,'title'])).toEqual('New Widget Title 2');});it('should apply transformer on sub-kind',function(){app.transform.register(['scene'],function(element){return element.setIn(['metadata','title'],'Home page');});var transformedAppState=transformer()((0,_immutable.fromJS)(appStateWithSubKinds));expect(transformedAppState.getIn(['children',0,'metadata','title'])).toEqual('Home page');});it('should apply transformer when there are multiple children elements',function(){app.transform.register('panel',function(element){return element.setIn(['metadata','title'],element.getIn(['metadata','title'])+' new');});var transformedAppState=transformer()((0,_immutable.fromJS)(appStateDualPanel));expect(transformedAppState.getIn(['left','metadata','title'])).toEqual('Title left new');expect(transformedAppState.getIn(['right',0,'metadata','title'])).toEqual('Title right 1 new');expect(transformedAppState.getIn(['right',1,'metadata','title'])).toEqual('Title right 2 new');});it('should apply transformer when there are multiple children elements, but elements do not have all the specified children',function(){app.transform.register('panel',function(element){return element.setIn(['metadata','title'],element.getIn(['metadata','title'])+' new');});var transformedAppState=transformer()((0,_immutable.fromJS)(appStateDualPanelSparse));expect(transformedAppState.getIn(['children',0,'left','metadata','title'])).toEqual('Title left new');expect(transformedAppState.getIn(['children',1,'right',0,'metadata','title'])).toEqual('Title right 1 new');expect(transformedAppState.getIn(['children',1,'right',1,'metadata','title'])).toEqual('Title right 2 new');});});
'use strict';var _enzyme=require("enzyme");var R=_interopRequireWildcard(require("ramda"));var _react=_interopRequireDefault(require("react"));var Subsystem=_interopRequireWildcard(require("../../subsystem"));var Kernel=_interopRequireWildcard(require("../../kernel"));var _=require("..");var _core=require("../../core");var _2=require("../..");var _jsxFileName="/Users/lukaskurucz/Git/skele/packages/classic/src/engine/__tests__/engine.js";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj;}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key)){var desc=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):{};if(desc.get||desc.set){Object.defineProperty(newObj,key,desc);}else{newObj[key]=obj[key];}}}}newObj.default=obj;return newObj;}}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};var ownKeys=Object.keys(source);if(typeof Object.getOwnPropertySymbols==='function'){ownKeys=ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function(sym){return Object.getOwnPropertyDescriptor(source,sym).enumerable;}));}ownKeys.forEach(function(key){_defineProperty(target,key,source[key]);});}return target;}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor;}function _possibleConstructorReturn(self,call){if(call&&(typeof call==="object"||typeof call==="function")){return call;}return _assertThisInitialized(self);}function _assertThisInitialized(self){if(self===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return self;}function _get(target,property,receiver){if(typeof Reflect!=="undefined"&&Reflect.get){_get=Reflect.get;}else{_get=function _get(target,property,receiver){var base=_superPropBase(target,property);if(!base)return;var desc=Object.getOwnPropertyDescriptor(base,property);if(desc.get){return desc.get.call(receiver);}return desc.value;};}return _get(target,property,receiver||target);}function _superPropBase(object,property){while(!Object.prototype.hasOwnProperty.call(object,property)){object=_getPrototypeOf(object);if(object===null)break;}return object;}function _getPrototypeOf(o){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o);};return _getPrototypeOf(o);}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function");}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:true,configurable:true}});if(superClass)_setPrototypeOf(subClass,superClass);}function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){o.__proto__=p;return o;};return _setPrototypeOf(o,p);}function _toConsumableArray(arr){return _arrayWithoutHoles(arr)||_iterableToArray(arr)||_nonIterableSpread();}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance");}function _iterableToArray(iter){if((typeof Symbol==="function"?Symbol.iterator:"@@iterator")in Object(iter)||Object.prototype.toString.call(iter)==="[object Arguments]")return Array.from(iter);}function _arrayWithoutHoles(arr){if(Array.isArray(arr)){for(var i=0,arr2=new Array(arr.length);i<arr.length;i++){arr2[i]=arr[i];}return arr2;}}describe('Engine: wiring everything together',function(){describe('EntryPoint',function(){var app=Subsystem.create(function(){return{name:'app'};});var Foo=function Foo(_ref){var element=_ref.element;return _react.default.createElement("div",{__source:{fileName:_jsxFileName,lineNumber:23}},element.get('kind'),": ",element.get('text'));};app.ui.register('c1',Foo);app.ui.register('c2',Foo);var capitalize=function capitalize(e){return e.update('text',R.toUpper);};var capitalizeTitles=function capitalizeTitles(n){return n.update('scenes',function(ss){return ss.map(capitalize);});};app.update.register('nav','.capitalize',capitalizeTitles);app.update.register('c1','capitalize',capitalize);var kernel;beforeEach(function(){return kernel=Kernel.create([].concat(_toConsumableArray(_core.defaultSubsystems),[app]),{kind:'nav',scenes:[{kind:'c1',text:'Scene 1'},{kind:'c2',text:'Scene 2'}]});});test('multiple entrypoints can be linked with a single kernel inst.',function(){var ep1=(0,_enzyme.mount)(_react.default.createElement(_.EntryPoint,{kernel:kernel,keyPath:['scenes',0],__source:{fileName:_jsxFileName,lineNumber:54}}));var ep2=(0,_enzyme.mount)(_react.default.createElement(_.EntryPoint,{kernel:kernel,keyPath:['scenes',1],__source:{fileName:_jsxFileName,lineNumber:55}}));expect(ep1).toIncludeText('c1: Scene 1');expect(ep2).toIncludeText('c2: Scene 2');});test('updates work accross different entrypoints',function(){var ep1=(0,_enzyme.mount)(_react.default.createElement(_.EntryPoint,{kernel:kernel,keyPath:['scenes',0],__source:{fileName:_jsxFileName,lineNumber:62}}));var ep2=(0,_enzyme.mount)(_react.default.createElement(_.EntryPoint,{kernel:kernel,keyPath:['scenes',1],__source:{fileName:_jsxFileName,lineNumber:63}}));ep1.find(Foo).at(0).props().dispatch({type:'capitalize'});expect(ep1).toIncludeText('c1: SCENE 1');ep1.find(Foo).at(0).props().dispatch({type:'.capitalize'});expect(ep2).toIncludeText('c2: SCENE 2');});});describe('Entrypoint with mixins',function(){var Wrapper=function Wrapper(Superclass){return function(_Superclass){_inherits(_class,_Superclass);function _class(){_classCallCheck(this,_class);return _possibleConstructorReturn(this,_getPrototypeOf(_class).apply(this,arguments));}_createClass(_class,[{key:"render",value:function render(){return _react.default.createElement("section",{id:"wrapper",__source:{fileName:_jsxFileName,lineNumber:87}},_get(_getPrototypeOf(_class.prototype),"render",this).call(this));}}]);return _class;}(Superclass);};var app=Subsystem.create(function(){return{name:'app',engineMixins:[Wrapper]};});var Foo=function Foo(_ref2){var element=_ref2.element;return _react.default.createElement("div",{__source:{fileName:_jsxFileName,lineNumber:97}},element.get('kind'),": ",element.get('text'));};app.ui.register('c1',Foo);var kernel=Kernel.create([].concat(_toConsumableArray(_core.defaultSubsystems),[app]),{kind:'c1',text:'wrapped'});test('mixins are applied around the entrypoint',function(){var e=(0,_enzyme.mount)(_react.default.createElement(_.EntryPoint,{kernel:kernel,keyPath:[],__source:{fileName:_jsxFileName,lineNumber:110}}));expect(e.find('section#wrapper')).toBePresent();});});describe('Engine',function(){afterEach(function(){_2.ui.reset();});var twiddlingMiddleware=R.curry(function(store,next,action){var nextAction;if(action.type==='twiddle'){nextAction=_objectSpread({},action,{type:'capitalize'});}else{nextAction=action;}return next(nextAction);});test('classic use (deprecations expected)',function(){var Foo=function Foo(_ref3){var element=_ref3.element;return _react.default.createElement("div",{__source:{fileName:_jsxFileName,lineNumber:131}},"Hello from ",element.get('text'));};_2.ui.register('s1',Foo);_2.update.register('s1',function(updates){updates.register('capitalize',function(e){return e.update('text',R.toUpper);});});var e=(0,_enzyme.mount)(_react.default.createElement(_.Engine,{initState:{kind:'s1',text:'s1'},__source:{fileName:_jsxFileName,lineNumber:138}}));expect(e).toIncludeText('Hello from s1');e.find(Foo).at(0).props().dispatch({type:'capitalize'});expect(e).toIncludeText('Hello from S1');});test('custom middleware',function(){var Foo=function Foo(_ref4){var element=_ref4.element;return _react.default.createElement("div",{__source:{fileName:_jsxFileName,lineNumber:150}},"Hello from ",element.get('text'));};_2.ui.register('m1',Foo);_2.update.register('m1',function(updates){updates.register('capitalize',function(e){return e.update('text',R.toUpper);});});var e=(0,_enzyme.mount)(_react.default.createElement(_.Engine,{initState:{kind:'m1',text:'m1'},customMiddleware:[twiddlingMiddleware],__source:{fileName:_jsxFileName,lineNumber:158}}));expect(e).toIncludeText('Hello from m1');e.find(Foo).at(0).props().dispatch({type:'twiddle'});expect(e).toIncludeText('Hello from M1');});test('additionalSubsystems',function(){var Foo=function Foo(_ref5){var element=_ref5.element;return _react.default.createElement("div",{__source:{fileName:_jsxFileName,lineNumber:174}},"Hello from ",element.get('text'));};_2.ui.register('ss1',Foo);_2.update.register('ss1',function(updates){updates.register('capitalize',function(e){return e.update('text',R.toUpper);});});var twiddler=Subsystem.create(function(){return{name:'twiddler',middleware:twiddlingMiddleware};});var e=(0,_enzyme.mount)(_react.default.createElement(_.Engine,{initState:{kind:'ss1',text:'ss1'},additionalSubsystems:[twiddler],__source:{fileName:_jsxFileName,lineNumber:187}}));expect(e).toIncludeText('Hello from ss1');e.find(Foo).at(0).props().dispatch({type:'twiddle'});expect(e).toIncludeText('Hello from SS1');});test('subsystems',function(){var Foo=function Foo(_ref6){var element=_ref6.element;return _react.default.createElement("div",{__source:{fileName:_jsxFileName,lineNumber:204}},"Hello from ",element.get('text'));};_2.ui.register('ssx1',Foo);_2.update.register('ssx1',function(updates){updates.register('capitalize',function(e){return e.update('text',R.toUpper);});});var twiddler=Subsystem.create(function(){return{name:'twiddler',middleware:twiddlingMiddleware};});var e=(0,_enzyme.mount)(_react.default.createElement(_.Engine,{initState:{kind:'ssx1',text:'ssx1'},subsystems:[].concat(_toConsumableArray(_core.defaultSubsystems),[twiddler]),__source:{fileName:_jsxFileName,lineNumber:217}}));expect(e).toIncludeText('Hello from ssx1');e.find(Foo).at(0).props().dispatch({type:'twiddle'});expect(e).toIncludeText('Hello from SSX1');});});});